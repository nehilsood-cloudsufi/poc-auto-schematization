You are an expert Data Commons engineer. Generate a Property-Value (PV) map that transforms input data into Data Commons format.

# HOW THE PROCESSOR WORKS

The processor converts each data cell into a StatVarObservation by collecting PVs from:
1. **Column Header** → collects those PVs
2. **Cell Value** → collects those PVs
3. **Row Header** → collects those PVs
4. **Merge** → all PVs form the complete observation

**Key Insight**: Column header properties apply to ALL cells in that column.

## CRITICAL: Detect Pre-Formatted Data Commons Data

**Before generating PVMAP, check if data is ALREADY in Data Commons format:**

### Detection Criteria:
1. **Has `variableMeasured` column** with DCID values like:
   - `dcid:Count_Person_Female`
   - `dcid:CumulativeCount_FoodBasket_Delivered`
   - `dcid:InterestRate_TreasuryBill_3Month_Primary`

2. **Has `observationAbout` column** with place/entity DCIDs:
   - `country/USA`, `geoId/06`, `wikidataId/Q391149`

3. **Has `observationDate` column** with standard formats:
   - `YYYY`, `YYYY-MM`, `YYYY-MM-DD`

4. **Has `value` column** with numeric measurements

### If Pre-Formatted → Use Passthrough Mapping:

```csv
observationAbout,observationAbout,{Data}
observationDate,observationDate,{Data}
variableMeasured,variableMeasured,{Data}
value,value,{Number}
```

**DO NOT:**
- ❌ Try to construct new `variableMeasured` entries
- ❌ Parse or deconstruct existing DCIDs
- ❌ Add `populationType`, `measuredProperty`, `statType` to columns that already have `variableMeasured`

**Example Pre-Formatted Data:**
```csv
observationAbout,observationDate,variableMeasured,value
country/BRA,2020-01,dcid:CumulativeCount_FoodBasket_Delivered,1500
```

**Correct PVMAP:**
```csv
key,property,value
observationAbout,observationAbout,{Data}
observationDate,observationDate,{Data}
variableMeasured,variableMeasured,{Data}
value,value,{Number}
```

---

## Required Properties

**StatVarObservation**: `value`, `observationDate`, `observationAbout`, `observationPeriod`, `unit`, `measurementMethod`, `scalingFactor`

**StatVar**: `populationType`, `measuredProperty`, `statType` + constraints (age, gender, race, etc.)

**NEVER map `variableMeasured`** - auto-constructed by processor.

---

# PV MAP FORMAT

`key,property1,value1,property2,value2,...`

- Keys must **exactly match** column headers or cell values (case-sensitive)
- Use `COLUMN:VALUE` syntax for values in specific columns (e.g., `place:Alabama`)
- Quote keys containing commas/special chars: `"ICD-10:#Heart (I00-I51)",causeOfDeath,X`

## CSV Escaping Rules

**Critical**: Output must be valid CSV parseable by Python's csv.reader:

1. **Backslashes must be escaped**: Use `\\` for literal backslash
   - ❌ Wrong: `"Doctor's\1\"`
   - ✅ Correct: `"Doctor's\\1"` or avoid backslashes entirely

2. **Quotes inside quoted fields**: Use double quotes `""`
   - ❌ Wrong: `"She said "hi""`
   - ✅ Correct: `"She said ""hi"""`

3. **Commas in keys**: Must double-quote the entire key
   - ✅ Correct: `"ICD-10:#Heart (I00-I51)",causeOfDeath,HeartDisease`

4. **Special characters to avoid**: `\`, unmatched quotes, newlines in keys

**Validation**: After generating PVMAP, ensure each line has:
- Proper comma separation
- Balanced quotes
- No trailing commas (unless intended empty values)

---

# COMPREHENSIVE EXAMPLE

**Input Data:**
```csv
Country or Area,Year,Sex,Value
Åland Islands,2023,Both Sexes,11785
Åland Islands,2023,Male,5630
Åland Islands,2023,Female,6155
United States,2023,Both Sexes,331000000
```

**PVMAP:**
```csv
key,prop,value,p2,v2,p3,v3,p4,v4
Country or Area:Åland Islands,observationAbout,country/AX
Country or Area:United States,observationAbout,country/USA
Year,observationDate,{Data}
Value,value,{Number},populationType,Person,measuredProperty,count,statType,measuredValue
Both Sexes,gender,
Male,gender,Male
Female,gender,Female
```

**Why this works:**
- Place names → explicit DCID mappings (dynamic `{Data}` won't resolve names)
- `Value` column has ALL StatVar properties (`populationType`, `measuredProperty`, `statType`)
- `Both Sexes` → empty gender (no constraint = total)
- Cell values (`Male`, `Female`) map to constraints

---

# DATA PATTERNS

## Pattern A: Flat Data (one observation per row)
```csv
REF_AREA,#Regex,"^(?P<Code>[A-Z]+):.*",observationAbout,country/{Code}
TIME_PERIOD,observationDate,{Data}
OBS_VALUE,value,{Number},populationType,FinancialInstrument,measuredProperty,interestRate,statType,measuredValue
M: Monthly,observationPeriod,P1M
```

## Pattern B: Wide Data (multiple value columns)

⚠️ **CRITICAL**: Each column MUST include ALL properties - no inheritance between columns.

```csv
Jan 2015,observationDate,2015-01,value,{Number},populationType,Person,measuredProperty,count,statType,measuredValue,observationAbout,country/USA
Feb 2015,observationDate,2015-02,value,{Number},populationType,Person,measuredProperty,count,statType,measuredValue,observationAbout,country/USA
```

**WRONG** (missing StatVar properties):
```csv
Jan 2015,observationDate,2015-01,value,{Number}
```

## Pattern C: Row+Column Combinations
```csv
place,measurementMethod,CensusSurvey
year,observationDate,{Data}
Male,gender,Male,value,{Number},populationType,Person,measuredProperty,count,statType,measuredValue
Female,gender,Female,value,{Number},populationType,Person,measuredProperty,count,statType,measuredValue
place:Alabama,observationAbout,geoId/01
```

## Pattern D: Dimension Properties (Categorical Constraints)

When data has categorical columns that constrain the StatVar (age, gender, race, education, etc.), map them as constraint properties:

```csv
# Core observation properties
Country,observationAbout,country/{Data}
Year,observationDate,{Data}
Value,value,{Number},populationType,Person,measuredProperty,count,statType,measuredValue

# Dimension constraints (map each category value)
gender:Male,gender,Male
gender:Female,gender,Female
gender:All,gender,
age:0-17,age,Years0To17
age:18-64,age,Years18To64
age:65+,age,Years65Onwards
race:White,race,WhiteAlone
race:Black,race,BlackOrAfricanAmericanAlone
```

**CRITICAL**: Dimension columns constrain the StatVar. They are NOT separate observation properties.

**When to use dimension properties:**
- Column represents a categorical attribute of the population being measured
- Values split the same measurement across different demographic groups
- Examples: age, gender, race, ethnicity, educationalAttainment, employmentStatus, disability, citizenship

**Wrong approach** (treating dimension as observation property):
```csv
# ❌ DON'T DO THIS
Value,value,{Number},populationType,Person,measuredProperty,count,statType,measuredValue,gender,Male
```

**Correct approach** (dimension as constraint):
```csv
# ✅ DO THIS
Value,value,{Number},populationType,Person,measuredProperty,count,statType,measuredValue
gender:Male,gender,Male
gender:Female,gender,Female
```

## Pattern E: Series ID Multiplexing (BLS-style)
```csv
Series ID,#ignore,skip
Series ID:CEU0000000001,populationType,BLSWorker,measuredProperty,count,naics,NAICS/10,name,"All Employees"
Jan 2015,observationDate,2015-01,value,{Number},observationPeriod,P1M,observationAbout,country/USA,populationType,BLSWorker,measuredProperty,count,statType,measuredValue
```

---

# SPECIAL SYNTAX

## Placeholders
- `{Data}` - Raw string value from cell
- `{Number}` - Numeric value from cell
- `{Key}` - The key string that was looked up

## Intermediate Variables
Capitalize to capture for later use (not included in StatVar):
```csv
year_col,Year,{Number}
month_col,#Regex,"M(?P<Month>[0-9]+)"
value_col,observationDate,{Year}-{Month},value,{Number}
```

## #Format - Zero-pad Values
```csv
FIPS,#Format,"observationAbout=geoId/{Number:05d}"        # 1001 → geoId/01001
state_fips,#Format,"observationAbout=geoId/{Number:02d}"  # 6 → geoId/06
```

## #Regex - Extract with Named Groups
```csv
REF_AREA,#Regex,"^(?P<Code>[A-Z]+):.*",observationAbout,country/{Code}
```
**Must use named groups** `(?P<Name>...)` - unnamed groups don't work.

## #Eval - Python Expressions
```csv
Status,#Eval,"active='Yes' if '{Data}' == 'Y' else 'No'"
```
**Always quote {Data}** in expressions.

## #ignore - Drop Rows
```csv
Series ID,#ignore,skip
```
Drops entire row containing this value. To skip value only, use empty intermediate: `BadValue,Skip,''`

---

# PLACE FORMATS

| Format | Example | Use Case |
|--------|---------|----------|
| `country/{Data}` | `country/USA` | ISO-3 codes in data |
| `geoId/{Number:02d}` | `geoId/06` | US state FIPS |
| `geoId/{Number:05d}` | `geoId/01001` | US county FIPS |
| `wikidataId/QXXXXX` | `wikidataId/Q22424` | Non-US places |
| `Earth` | `Earth` | Global data |

⚠️ **Dynamic construction does NOT work**: `observationAbout,{Country}/{City}` fails.

**Use explicit mappings for place names:**
```csv
Country or Area:Åland Islands,observationAbout,country/AX
srcStateName:Punjab,observationAbout,wikidataId/Q22424
```

## Composite FIPS (state + county)
```csv
statefips,StateFips,{Data}
countyfips,#Format,"observationAbout=geoId/{StateFips}{Number:03d}"
```

---

# CRITICAL RULES

1. **EVERY observation MUST have observationAbout** - This is the geographic/organizational unit being measured
   - Without it: Validation will fail with "Unable to resolve SVObs place" and produce 0 output rows
   - Common sources: Country columns, state columns, county codes, organization IDs
   - If no place column exists, check if data is about a single fixed location (e.g., country/USA)
   - **Test your PVMAP**: Search for "observationAbout" in your mappings - there MUST be at least one

2. **Keys must exactly match** input data (case-sensitive)
3. **Use exact Data Commons vocabulary** - Property names must match DC schema exactly
   - Check schema examples for correct property names
   - Common mistakes:
     - ❌ `benefitProgram` → ✅ `beneficiaryProgram`
     - ❌ `populationGroup` → ✅ `populationType`
     - ❌ `measurement` → ✅ `measuredProperty`
   - If unsure, reference the schema examples provided
4. **Quote keys with special chars**: commas, parentheses, quotes
5. **Every value column needs ALL properties**: `value,{Number}`, `populationType`, `measuredProperty`, `statType`
6. **>5-10 categorical values?** Use explicit mappings, not regex
7. **Place names require explicit DCID mappings** - no dynamic resolution

---

# KNOWN LIMITATIONS (require preprocessing)

- Carry-forward/sparse data (values not repeated per row)
- Multi-row headers / merged cells
- Footer/metadata rows after blank lines
- ISO-2 country codes (need conversion to ISO-3)

Non-numeric placeholders (`#`, `*`, `N/A`, `Unreliable`) are auto-skipped.

---

# COMMON MISTAKES

1. Missing StatVar properties on value columns
2. Partial key matches (`AR` won't match `AR: Argentina`)
3. Wide data without complete properties per column
4. Dynamic place construction instead of explicit mappings
5. Single regex for 50+ codes instead of explicit list
6. Ignoring column then referencing it (`#ignore` + `{Year}`)
7. Missing observationAbout entirely (causes complete validation failure with 0 rows)
8. Mapping date/time columns instead of place columns to key observations
9. Using similar but incorrect property names (benefitProgram vs beneficiaryProgram)
10. Inventing new property names not in Data Commons vocabulary

---

# SCHEMA EXAMPLES

{{SCHEMA_EXAMPLES}}

---

# WORKED EXAMPLES FROM FAILED DATASETS

## Example 1: Missing observationAbout (FEMA Dataset)

**Input Data:**
```csv
State,Year,Disasters,TotalAmount
AL,2020,5,1234567
FL,2021,8,9876543
```

**Wrong PVMAP** (causes validation failure):
```csv
Year,observationDate,{Data}
Disasters,value,{Number},populationType,NaturalDisaster,measuredProperty,count,statType,measuredValue
```
**Error**: "Unable to resolve SVObs place" → 0 output rows

**Correct PVMAP:**
```csv
State,observationAbout,geoId/{StateCode}
State:AL,StateCode,01
State:FL,StateCode,12
Year,observationDate,{Data}
Disasters,value,{Number},populationType,NaturalDisaster,measuredProperty,count,statType,measuredValue
```

---

## Example 2: Pre-Formatted Data (Brazil Food Basket)

**Input Data:**
```csv
observationAbout,observationDate,variableMeasured,value
country/BRA,2020-01,dcid:CumulativeCount_FoodBasket_Delivered,1500
country/BRA,2020-02,dcid:CumulativeCount_FoodBasket_Delivered,1750
```

**Wrong PVMAP** (tries to reconstruct):
```csv
variableMeasured:dcid:CumulativeCount_FoodBasket_Delivered,populationType,FoodBasket,measuredProperty,cumulativeCount,statType,measuredValue,measurementMethod,Delivered
```
**Result**: 0% accuracy - completely wrong structure

**Correct PVMAP** (passthrough):
```csv
observationAbout,observationAbout,{Data}
observationDate,observationDate,{Data}
variableMeasured,variableMeasured,{Data}
value,value,{Number}
```

---

## Example 3: Missing Dimension Properties (School Retention)

**Input Data:**
```csv
State,Year,Gender,Race,Grade,Value
AL,2020,Male,White,9,95.5
AL,2020,Female,Black,9,93.2
```

**Wrong PVMAP** (ignores dimensions):
```csv
State,observationAbout,geoId/{StateCode}
Year,observationDate,{Data}
Value,value,{Number},populationType,Student,measuredProperty,retentionRate,statType,measuredValue
```
**Result**: 0% accuracy - missing all categorical dimensions

**Correct PVMAP:**
```csv
State,observationAbout,geoId/{StateCode}
Year,observationDate,{Data}
Value,value,{Number},populationType,Student,measuredProperty,retentionRate,statType,measuredValue

# Map dimension columns
Gender:Male,gender,Male
Gender:Female,gender,Female
Race:White,race,WhiteAlone
Race:Black,race,BlackOrAfricanAmericanAlone
Grade:9,schoolGradeLevel,Grade9
```

---

# INPUT DATA

{{SAMPLED_DATA}}

---

# PROCESSOR CONFIG

{{METADATA_CONFIG}}

---

# OUTPUT

Provide ONLY pvmap.csv content in a csv code block.

**CHECKLIST:**
- [ ] **Data format detected**: Is this pre-formatted DC data or raw data?
  - [ ] If pre-formatted (has variableMeasured column with DCIDs): Use passthrough mapping
  - [ ] If raw data: Construct full StatVar properties
- [ ] **observationAbout mapped**: MUST have at least one mapping for observationAbout
  - [ ] Identify location/entity column in input data
  - [ ] Map to correct DCID format (country/, geoId/, wikidataId/, Earth)
- [ ] **Keys exactly match input** (case-sensitive)
- [ ] **Special char keys double-quoted**
- [ ] **CSV formatting valid**:
  - [ ] No unescaped backslashes
  - [ ] Proper quote escaping
  - [ ] Parseable by Python csv.reader
- [ ] **Every value column has**:
  - [ ] `value,{Number}` (or appropriate placeholder)
  - [ ] `populationType`, `measuredProperty`, `statType` (if NOT pre-formatted data)
  - [ ] OR `variableMeasured,{Data}` (if pre-formatted data)
- [ ] **Dimension columns mapped**: If data has categorical splits (age, gender, race), map each value
- [ ] **observationDate format**: YYYY, YYYY-MM, or YYYY-MM-DD
- [ ] **observationAbout uses valid DCID** (geoId/, country/, wikidataId/, Earth)
- [ ] **No dynamic place construction** - explicit mappings only
- [ ] **#Regex uses named groups** `(?P<Name>...)`
- [ ] **Property names match DC vocabulary** - check schema examples
- [ ] Note any data limitations in response
