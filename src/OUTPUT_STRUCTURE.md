# src/output/ Directory Structure

## Overview

**All pipeline outputs, logs, and artifacts are saved to `src/output/`**

This document describes the complete output structure generated by the ADK pipeline with comprehensive logging.

## Directory Structure

```
src/output/
├── logs/                                # Centralized logging directory
│   ├── adk_trace_{session_id}.yaml     # ADK DebugLoggingPlugin traces
│   ├── pipeline_{session_id}.log       # Python logging output
│   └── ...                             # One set of logs per pipeline run
│
└── {dataset_name}/                     # Per-dataset output directory
    ├── generated_pvmap.csv             # Final PVMAP output (main result)
    ├── generation_notes.md             # Execution timeline & reasoning
    ├── populated_prompt.txt            # Prompt sent to LLM
    ├── processed.csv                   # Validation output (StatVarObservations)
    ├── processed.mcf                   # StatVar definitions
    ├── processed.tmcf                  # Template MCF
    └── generated_response/             # Per-attempt LLM responses
        ├── attempt_0.md                # First attempt
        ├── attempt_1.md                # First retry (if needed)
        └── attempt_2.md                # Second retry (if needed)
```

## File Descriptions

### Logs Directory (`src/output/logs/`)

#### `adk_trace_{session_id}.yaml`
**Source:** ADK DebugLoggingPlugin (Layer 1)
**Format:** YAML
**Content:**
- Complete execution trace
- All invocations with timestamps
- LLM requests with full prompts
- LLM responses with content
- Token usage (prompt/completion/total)
- Function calls and responses
- State mutations
- Session snapshots

**Example:**
```yaml
---
invocation_id: "inv_abc123"
session_id: "session_xyz"
start_time: "2026-01-28T10:30:00"
entries:
  - timestamp: "2026-01-28T10:30:01"
    entry_type: "llm_request"
    agent_name: "PVMAPGeneration"
    data:
      model: "gemini-3-pro-preview"
      content: "..."
      tools: [...]
```

#### `pipeline_{session_id}.log`
**Source:** Python logging (Layer 3)
**Format:** Text (standard Python logging format)
**Content:**
- Timestamped log messages
- DEBUG/INFO/WARNING/ERROR levels
- Traditional log file format

**Example:**
```
2026-01-28 10:30:00,123 - adk_pipeline_xyz - INFO - Starting PVMAP pipeline
2026-01-28 10:30:05,456 - adk_pipeline_xyz - DEBUG - Discovery completed
2026-01-28 10:30:10,789 - adk_pipeline_xyz - WARNING - Validation failed, retrying
```

### Dataset Directory (`src/output/{dataset_name}/`)

#### `generated_pvmap.csv`
**Source:** PVMAP Generation Agent
**Format:** CSV
**Content:** The final Property-Value Mapping for the dataset

**Example:**
```csv
key,property1,value1,property2,value2
State FIPS,StateFIPS,{Data},,
Year,observationDate,{Data},,
Population,populationType,Person,measuredProperty,count,value,{Number}
```

#### `generation_notes.md`
**Source:** ArtifactLoggingPlugin (Layer 2)
**Format:** Markdown
**Content:**
- Execution summary
- Final state (success/failure)
- Number of attempts
- Validation results
- Complete timeline with timestamps
- Token usage per attempt
- Error feedback (if any)

**Example:**
```markdown
# PVMAP Generation Notes: bis_bis_central_bank_policy_rate

**Generated:** 2026-01-28T10:30:00
**Invocation ID:** inv_abc123
**Session ID:** session_xyz

## Final State

- Generation success: True
- Attempts made: 2
- Validation passed: True

## Execution Timeline

### Attempt 0 - 2026-01-28T10:30:05
- Tokens: 15234
- Response length: 5678 chars

### validation - 2026-01-28T10:30:15
- Content: Validation failed: No place in SVObs...

### Attempt 1 - 2026-01-28T10:31:00
- Tokens: 16789
- Response length: 6012 chars
```

#### `populated_prompt.txt`
**Source:** PVMAP Generation Agent
**Format:** Text
**Content:** The complete prompt sent to the LLM, including:
- Schema examples
- Sampled data
- Metadata
- Instructions
- Error feedback (on retries)

#### `processed.csv`
**Source:** stat_var_processor (validation)
**Format:** CSV
**Content:** StatVarObservations generated from the PVMAP

**Example:**
```csv
observationAbout,observationDate,variableMeasured,value
country/USA,2020,Count_Person_Population,331000000
```

#### `processed.mcf` & `processed.tmcf`
**Source:** stat_var_processor (validation)
**Format:** MCF (Data Commons format)
**Content:** StatVar definitions and templates

### Generated Response Directory (`src/output/{dataset_name}/generated_response/`)

#### `attempt_{N}.md`
**Source:** ArtifactLoggingPlugin (Layer 2)
**Format:** Markdown
**Content:** Complete LLM response for each generation attempt

**Example:**
```markdown
# PVMAP Generation Attempt 0

**Timestamp:** 2026-01-28T10:30:05.123456
**Agent:** PVMAPGeneration
**Invocation ID:** inv_abc123

**Token Usage:**
- Prompt tokens: 10234
- Response tokens: 5000
- Total tokens: 15234

## Response

[Full LLM response text here...]
```

## Output Configuration

All output paths are configured in the following files:

### `src/utils/logging_config.py`
```python
# Creates logs in: output_dir / "logs"
logs_dir = output_dir / "logs"
logs_dir.mkdir(parents=True, exist_ok=True)

# YAML trace
debug_file = logs_dir / f"adk_trace_{session_id}.yaml"

# Python log
fh = logging.FileHandler(logs_dir / f"pipeline_{session_id}.log")
```

### `src/utils/artifact_plugin.py`
```python
# Creates dataset output directory
self.dataset_dir = output_dir / dataset_name
self.dataset_dir.mkdir(parents=True, exist_ok=True)

# Creates response directory
self.response_dir = self.dataset_dir / "generated_response"
self.response_dir.mkdir(exist_ok=True)

# Saves generation notes
notes_file = self.dataset_dir / "generation_notes.md"

# Saves attempt files
attempt_file = self.response_dir / f"attempt_{self.attempt_count}.md"
```

### `src/run_pipeline.py`
```python
# All functions use output_dir parameter
output_dir = Path("src/output")

# Example usage:
setup_adk_logging(output_dir=output_dir, ...)
setup_python_logging(output_dir=output_dir, ...)
ArtifactLoggingPlugin(output_dir=output_dir, ...)
```

## Usage Examples

### View All Outputs for a Dataset
```bash
ls -R src/output/bis_bis_central_bank_policy_rate/
```

### Check Latest Logs
```bash
ls -lt src/output/logs/ | head -10
```

### View Generation Notes
```bash
cat src/output/{dataset_name}/generation_notes.md
```

### View Specific Attempt
```bash
cat src/output/{dataset_name}/generated_response/attempt_1.md
```

### View YAML Trace
```bash
cat src/output/logs/adk_trace_{session_id}.yaml
```

### View Python Logs
```bash
tail -f src/output/logs/pipeline_{session_id}.log
```

## Verification

To verify all outputs save to `src/output/`:

```bash
python3 verify_output_paths.py
```

This will:
1. Check ADK logging paths → ✅ src/output/logs/
2. Check Python logging paths → ✅ src/output/logs/
3. Check artifact plugin paths → ✅ src/output/{dataset}/
4. List all current files in src/output/

## Summary

**✅ Everything saves to `src/output/`**

- **Logs:** `src/output/logs/`
- **Dataset outputs:** `src/output/{dataset_name}/`
- **Artifacts:** `src/output/{dataset_name}/generated_response/`

No outputs are written outside of `src/output/` directory.
